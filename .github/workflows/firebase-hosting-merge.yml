# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
"on":
  push:
    branches:
      - main

permissions:
  checks: write
  contents: read
  pull-requests: write
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    env:
      VITE_API_URL: "${{ vars.VITE_API_URL }}"
      VITE_WS_URL: "${{ vars.VITE_WS_URL }}"
      VITE_ALLOW_REGISTRATION: "${{ vars.VITE_ALLOW_REGISTRATION }}"
      VITE_SENTRY_DSN: "${{ vars.VITE_SENTRY_DSN }}"
      VITE_ENV: "production"
      VITE_FIREBASE_API_KEY: "${{ vars.VITE_FIREBASE_API_KEY }}"
      VITE_FIREBASE_PROJECT_ID: "${{ vars.VITE_FIREBASE_PROJECT_ID }}"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "latest"

      - name: Wake up GraphQL server
        uses: ./.github/actions/wake-graphql-server
        with:
          api-url: ${{ env.VITE_API_URL }}

      - name: Install dependencies
        run: |
          bun install
          bun run codegen

      - name: Test
        run: bun run test

      - name: Build
        run: bun run build

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: "${{ secrets.GITHUB_TOKEN }}"
          firebaseServiceAccount: "${{ secrets.FIREBASE_SERVICE_ACCOUNT_ORACLE_ENGINE_7DFA6 }}"
          channelId: live
          projectId: oracle-engine-7dfa6
