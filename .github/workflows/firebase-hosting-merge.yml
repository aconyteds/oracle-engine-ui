# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
"on":
    push:
        branches:
            - main

permissions:
    checks: write
    contents: read
    pull-requests: write
jobs:
    build_and_deploy:
        runs-on: ubuntu-latest
        env:
            VITE_API_URL: "${{ vars.VITE_API_URL }}"
            VITE_WS_URL: "${{ vars.VITE_WS_URL }}"
            VITE_ALLOW_REGISTRATION: "${{ vars.VITE_ALLOW_REGISTRATION }}"

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: "latest"

            - name: Wake up GraphQL server
              run: |
                  echo "Attempting to wake up GraphQL server at $VITE_API_URL"
                  timeout=300  # 5 minutes
                  interval=10  # 10 seconds between attempts
                  elapsed=0
                  
                  while [ $elapsed -lt $timeout ]; do
                      echo "Pinging server... (attempt $((elapsed/interval + 1)))"
                      if curl -f -s --max-time 10 "$VITE_API_URL" > /dev/null 2>&1; then
                          echo "✅ Server is awake and responding!"
                          break
                      fi
                      
                      echo "Server not responding, waiting ${interval}s..."
                      sleep $interval
                      elapsed=$((elapsed + interval))
                  done
                  
                  if [ $elapsed -ge $timeout ]; then
                      echo "❌ Timeout: Server did not respond within 5 minutes"
                      exit 1
                  fi

            - name: Install dependencies
              run: |
                  bun install
                  bun run codegen

            - name: Test
              run: bun run test

            - name: Build
              run: bun run build

            - name: Deploy to Firebase Hosting
              uses: FirebaseExtended/action-hosting-deploy@v0
              with:
                  repoToken: "${{ secrets.GITHUB_TOKEN }}"
                  firebaseServiceAccount: "${{ secrets.FIREBASE_SERVICE_ACCOUNT_ORACLE_ENGINE_7DFA6 }}"
                  channelId: live
                  projectId: oracle-engine-7dfa6
