# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Oracle Engine UI is a React + TypeScript + Vite chat application for AI model interaction. It uses GraphQL (Apollo Client) for API communication, Firebase for authentication and hosting, and Bootstrap with custom SCSS theming. The application features a split-panel layout with a resizable chat panel and display area for future modal/draggable components.

## Essential Commands

### Development
- `bun run dev` - Start Vite dev server on http://localhost:5173
- `bun run build` - TypeScript compile + Vite build (takes ~11s)
- `bun run start` - Build and serve with Firebase emulator on http://127.0.0.1:5000

### Code Quality
- `bun run lint` - Run Biome linter and formatter checks
- `bun run lint:write` - Run Biome checks and apply safe fixes
- `bun run format` - Auto-format code with Biome
- `bun run test` - Run Vitest unit tests

### GraphQL
- `bun run codegen` - Generate TypeScript types from GraphQL schema

**CRITICAL**: `bun run codegen` requires a running GraphQL server at localhost:4000. Connection refused errors are expected when the backend is unavailable.

## Architecture

### Application Structure

The app follows a provider-based architecture with nested contexts:

```
ThemeProvider
└── UserProvider (Firebase Auth)
    └── Router
        └── ProtectedRoute
            └── ThreadsProvider (Chat State)
                └── Layout
```

### Key Architectural Patterns

**Apollo Client Configuration** (`src/apolloClient.ts`):
- HTTP link for queries/mutations, WebSocket link for subscriptions
- `waitForTokenLink` delays GraphQL requests until Firebase auth token is set via `setAuthToken()`
- Split link routes operations based on type (subscription vs query/mutation)

**Context Providers**:
- `UserProvider`: Manages Firebase authentication, fetches user from GraphQL, sets auth token
- `ThreadsProvider`: Thread/message state, uses session storage for persistence (`selectedThreadId`)
- `ThemeProvider`: Dark/light mode theming
- `ToasterProvider`: Toast notification system

**Layout System** (`src/components/Layout/`):
- `Layout.tsx`: Root container with Header and ResizablePanel
- `ChatPanel.tsx`: Left panel with messages (column-reverse scroll), input, and HealthCheck footer
- `Main.tsx`: Right panel, relatively positioned for future draggable modals
- `ResizablePanel.tsx`: Draggable vertical divider between panels (400px default, 300-800px range)
- `ChatHistoryFlyout.tsx`: Bootstrap Offcanvas for thread selection (hamburger menu in header)

### GraphQL Integration

**Schema Files**: `src/graphql/*.graphql`
- `User.graphql` - CurrentUser query
- `Threads.graphql` - GetThreadByID, GetMyThreads queries with ThreadDetails fragment
- `Messages.graphql` - CreateMessage mutation, MessageDetails fragment, message subscriptions
- `Info.graphql` - Health check queries

**Generated Types**: `src/graphql/generated.ts` (gitignored)
- Auto-generated by GraphQL Code Generator
- Provides TypeScript types and Apollo hooks (`useQuery`, `useMutation`, `useSubscription`)

**Path Aliases** (configured in `vite.config.ts`):
- `@graphql` → `src/graphql/generated.ts`
- `@hooks` → `src/hooks/index.tsx`
- `@context` → `src/contexts/index.tsx`

### Custom Hooks

Located in `src/hooks/`:
- `useStorage.tsx`: localStorage/sessionStorage with type safety
- `useArray.tsx`: Array state management with push/set/clear helpers
- `useMap.tsx`: Map-based state with getItem/setItem/rebase helpers
- `useTheme.tsx`: Access theme context (dark/light mode)

### State Management Pattern

ThreadsContext demonstrates the data flow:
1. `useSessionStorage` persists `selectedThreadId` across page reloads
2. `useGetMyThreadsLazyQuery` fetches all threads on mount
3. `useMap` stores threads with O(1) lookup by ID
4. `useGetThreadByIdQuery` fetches messages for selected thread
5. `useArray` manages message list with append operations
6. `useCreateMessageMutation` sends messages, refetches threads, updates selection

### Firebase Configuration

- Project: `oracle-engine-7dfa6`
- Authentication: Google OAuth provider
- Analytics: Event tracking with `LogEvent()` function
- Hosting: Serves from `dist/` directory

## Development Workflow

### Testing Changes

After making changes, always:
1. Run `bun run lint` - Biome will check formatting and linting rules
2. Run `bun run test` - Ensure all tests pass
3. Start dev server (`bun run dev`) and verify login screen at http://localhost:5173/login
4. Test authentication flow and chat functionality

### Writing Tests

**IMPORTANT**: When writing or modifying tests, refer to `.claude/skills/testing.md` for comprehensive testing best practices.

Key testing principles:
- Use `test.each` for repetitive tests with similar patterns (reduces duplication)
- Import `render`, `screen`, etc. from `../../test-utils` (not `@testing-library/react` directly)
- Always use `vi.clearAllMocks()` in `beforeEach` and `cleanup()` in `afterEach`
- Expected console output is suppressed globally in `setupTests.ts`
- Use `suppressConsole()` from `test-utils/consoleUtils.ts` for per-test console control

### Adding GraphQL Operations

1. Add operation to appropriate `.graphql` file in `src/graphql/`
2. Run `bun run codegen` (requires backend server running)
3. Import generated hooks from `@graphql` alias
4. Example: `useCreateMessageMutation`, `useGetThreadByIdQuery`

### Adding Components

- Place in `src/components/` subdirectories by feature
- Export through `index.tsx` for clean imports
- Use TypeScript, React hooks, styled-components, Bootstrap classes
- Create corresponding `.test.tsx` files
- Component-specific SCSS in same directory

### Styling

- Main stylesheet: `src/theme/main.scss`
- Custom Bootstrap theme: `src/theme/Sketchy/`
- Component SCSS modules: `Component.scss` alongside `Component.tsx`
- Bootstrap 5.3.5 with custom variables

## Environment Variables

Required in `.env`:
- `VITE_API_URL` - GraphQL HTTP endpoint (default: http://localhost:4000/graphql)
- `VITE_WS_URL` - GraphQL WebSocket endpoint (default: ws://localhost:4000/graphql)
- `VITE_ALLOW_REGISTRATION` - Show/hide registration UI

## Important Notes

- Uses Bun package manager (not npm/yarn)
- Uses Biome for linting and formatting (replaced ESLint and Prettier)
- Pre-commit hooks run `bunx lint-staged` to check and format staged files
- Biome config in `biome.json` with VCS integration enabled
- Biome ignores: `**/generated.ts`, `**/*.generated.ts`, `dist/`, `node_modules/`
- Formatting: 4-space indentation, semicolons, double quotes, 80 char line width
- Build output: `dist/` directory
- NEVER cancel builds (`bun run build`) - they complete in ~11 seconds
- Vitest uses jsdom environment for React component testing
- Test utilities in `src/test-utils/` provide custom render with providers and console suppression utilities

## CI/CD Pipeline

GitHub Actions workflow:
1. Install Bun and dependencies
2. Run GraphQL codegen (requires `VITE_API_URL` secret)
3. Run tests
4. Build application
5. Deploy to Firebase (merge to main) or create preview (PRs)

Required GitHub secrets:
- `VITE_API_URL`, `VITE_WS_URL`, `VITE_ALLOW_REGISTRATION`
- `FIREBASE_SERVICE_ACCOUNT_ORACLE_ENGINE_7DFA6`

## Skills

Project-specific skills are located in `.claude/skills/`:
- `testing.md` - Testing best practices, patterns, and utilities for this codebase
